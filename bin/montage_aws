#!/usr/bin/env ruby
require 'montage_aws'
require 'yaml'
require 'aws'

CONFIG_FILE="#{ENV['HOME']}/.montage_aws.yml"

include MontageAWS

default_config = {
    :domain => "montage_aws",
    :workflow_name => "mock_computation",
    :workflow_version => "0.0.1",
    :default_task_list => "computation-task-list",
}

config = File.exists?(CONFIG_FILE) ? YAML.load(File.open(CONFIG_FILE)) : default_config
AWS.config(config[:aws])

activities = {
    :provision => StartEC2Worker,
    :project => Project,
    :merge => Merge
}

spec = {
    :setup => Provision,
    :compute => Compute,
    :start_daemon => Decider,
    :start_provider => EC2Provider,
    :start_worker => Worker,
}

params = {
    :config => config,
    :swf => AWS::SimpleWorkflow.new,
    :ec2 => AWS::EC2.new,
    :s3 => AWS::S3.new,
    :montage => Montage.new,
    :logger => $stderr
}

activity_fac = ActivityFactory.new activities, params
task_fac = CmdFactory.new(activity_fac, spec, params)

begin
  cmd = Cmd.new ARGV
  task = task_fac.create_from_cmd cmd
  task.execute_cmd
rescue RuntimeError => e
  $stderr.puts "error: #{e.message}"
end
